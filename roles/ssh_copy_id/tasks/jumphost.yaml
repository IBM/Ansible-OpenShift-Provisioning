---
- name: Delete SSH key from known hosts if it already exists for idempotency
  tags: ssh_copy_id, ssh
  lineinfile:
    path: "~/.ssh/known_hosts"
    search_string: "{{ hostvars[ssh_target].ansible_host }}"
    state: absent

- name: Template expect script out to jumphost.
  tags: ssh_copy_id, ssh
  template:
    src: ssh-copy-id.exp.j2
    dest: "~/.ssh/ssh-copy-id-expect-pass.exp"
    force: yes

- name: Copy SSH ID from jumphost to remote host using expect script.
  tags: ssh_copy_id, ssh
  command: "expect ~/.ssh/ssh-copy-id-expect-pass.exp"
  register: ssh_copy
  failed_when: "'Now try logging into the machine' not in ssh_copy.stdout"

- name: Print results of copying ssh id to remote host.
  tags: ssh_copy_id, ssh
  debug:
    var: ssh_copy

- name: Delete templated expect script.
  tags: ssh_copy_id, ssh
  file:
    path: "~/.ssh/ssh-copy-id-expect-pass.exp"
    state: absent
