---
- name: Template DNS configuration files to bastion.
  tags: dns
  vars:
    bastion_split_ip: "{{ hostvars['bastion'].bastion_ip.split('.') }}"
    bootstrap_split_ip: "{{ hostvars['bootstrap_node'].node_ip.split('.') }}"
  ansible.builtin.template:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
    owner: root
    group: root
    mode: "0644"
    backup: yes
  loop:
    - { src: dns-named.conf.j2, dest: /etc/named.conf }
    - { src: dns.db.j2, dest: "/var/named/{{ metadata_name }}.db" }
    - { src: dns.rev.j2, dest: "/var/named/{{ metadata_name }}.rev" }
    - { src: resolv.conf.j2, dest: /etc/resolv.conf }

- name: Restart named to update changes made to DNS
  tags: dns, resolv
  ansible.builtin.systemd:
    name: named
    state: restarted
    enabled: yes

- name: Restart network to update changes made to /etc/resolv.conf
  tags: dns, resolv
  ansible.builtin.service:
    name: network
    state: restarted
