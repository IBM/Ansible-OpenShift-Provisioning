---
- name: Create a directory on the hypervisor for bastion's configuration files
  tags: create_bastion
  ansible.builtin.file:
    path: "{{ cfgs_dir }}/{{ hostvars['bastion'].fqdn.split('.')[0] }}"
    mode: "0755"
    state: directory

- name: Create hash from bastion's root password to input in kickstart file
  tags: create_bastion
  ansible.builtin.shell: |
    set -o pipefail
    echo "{{ hostvars['bastion'].root_pass }}" | openssl passwd -6 -in -
  register: root_pass_hash

- name: Create hash from bastion user password to input in kickstart file
  tags: create_bastion
  ansible.builtin.shell: |
    set -o pipefail
    echo "{{ hostvars['bastion'].ansible_become_password }}" | openssl passwd -6 -in -
  register: user_pass_hash

- name: Template kickstart file to hypervisor
  tags: create_bastion
  ansible.builtin.template:
    src: "bastion-ks.cfg.j2"
    dest: "{{ cfgs_dir }}/{{ hostvars['bastion'].fqdn.split('.')[0] }}/bastion-ks.cfg"
    mode: "0644"
    force: true

- name: Boot and kickstart bastion. To monitor, login to your KVM host and run 'virsh console <bastion VM name>'
  tags: create_bastion, virt-install
  ansible.builtin.shell: |
    set -o pipefail
    virsh destroy {{ hostvars['bastion'].vm_name }} || true
    virsh undefine {{ hostvars['bastion'].vm_name }} --remove-all-storage || true
    virt-install \
    --name {{ hostvars['bastion'].vm_name }} \
    --os-variant={{ hostvars['file_server'].iso_os_variant | lower }} \
    --autostart \
    --memory={{ hostvars['bastion'].ram }} \
    --vcpus={{ hostvars['bastion'].vcpu }} \
    --location {{ hostvars['file_server'].protocol }}://{{ hostvars['file_server'].fs_user + ':' + hostvars['file_server'].fs_pass + '@' if hostvars['file_server'].protocol == 'ftp' else '' }}{{ hostvars['file_server'].fs_ip }}/{{ hostvars['file_server'].iso_mount_dir }} \
    --disk pool={{ pool_name }},size={{ hostvars['bastion'].disk_size }} \
    --network network={{ network_name }} \
    --graphics=none \
    --noautoconsole --wait=-1 \
    --initrd-inject "{{ cfgs_dir }}/{{ hostvars['bastion'].fqdn.split('.')[0] }}/bastion-ks.cfg" \
    --extra-args "inst.ks=file:/bastion-ks.cfg ip={{ hostvars['bastion'].bastion_ip }}::{{ hostvars['bastion'].gateway }}\
    :{{ hostvars['bastion'].netmask }}:{{ hostvars['bastion'].fqdn.split('.')[0] }}:enc1:none console=ttysclp0"