---

- hosts: localhost
  tags: localhost
  connection: local
  become: False
  gather_facts: True
  roles:
    - set_inventory

  post_tasks:
    - name: Ensure Ansible Galaxy collections have been installed.
      tags: galaxy
      command: ansible-galaxy collection install {{ item }}
      loop: "{{ env.pkgs.galaxy }}"

    - name: Find ibm_zhmc collection install location, if automated LPAR creation is to be used.
      tags: galaxy
      shell: ansible-galaxy collection list ibm.ibm_zhmc | grep -i ansible | cut -c 3-
      register: zhmc_path
      when: hostvars[groups['kvm_host'][0]]['create'] or hostvars[groups['kvm_host'][1]]['create'] or hostvars[groups['kvm_host'][2]]['create']

    - name: Ensure zhmcclient requirements are installed.
      tags: galaxy
      pip:
        requirements: "{{ zhmc_path.stdout }}/ibm/ibm_zhmc/requirements.txt"
        executable: pip3
        extra_args: --upgrade
      when: hostvars[groups['kvm_host'][0]]['create'] or hostvars[groups['kvm_host'][1]]['create'] or hostvars[groups['kvm_host'][2]]['create']

- hosts: localhost
  connection: local
  become: False
  gather_facts: True
  vars_files:
    - "{{ inventory_dir }}/group_vars/all.yaml"
  vars:
    packages: "{{ env.pkgs.controller }}"
    ssh_target: [ "{{ env.file_server.ip }}", "{{ env.file_server.user }}", "{{ env.file_server.pass }}", "{{ path_to_key_pair }}" ]
  roles:
    - install_packages
    - ssh_key_gen
    - ssh_agent
    - ssh_copy_id #to file server